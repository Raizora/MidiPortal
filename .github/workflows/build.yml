name: Build and Test

on:
  push:
    branches:
      - experimental
      - ci-test
  pull_request:
    branches:
      - experimental
      - ci-test
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug WebKitGTK Installation
        run: |
          sudo apt-get update
          apt-cache search webkit | grep webkit

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev || echo "WebKitGTK 4.0 not found, proceeding without it." \
            ninja-build

      - name: Debug WebKitGTK Detection
        run: |
          echo "Checking WebKitGTK versions..."
          pkg-config --modversion webkit2gtk-4.1 || echo "webkit2gtk-4.1 NOT FOUND"
          pkg-config --modversion webkit2gtk-4.0 || echo "webkit2gtk-4.0 NOT FOUND"
          
          echo "Checking pkg-config paths..."
          pkg-config --cflags webkit2gtk-4.0 || echo "No include paths found for webkit2gtk-4.0"
          pkg-config --cflags webkit2gtk-4.1 || echo "No include paths found for webkit2gtk-4.1"
          
          echo "Checking for missing dependencies..."
          ldd /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.0.so || echo "Missing WebKitGTK shared libraries!"

      - name: Verify Ninja Installation
        run: |
          ninja --version || { echo "Ninja NOT found!"; exit 1; }

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Build Rust Library
        working-directory: rust
        run: cargo build --release

      - name: Clone JUCE
        run: |
          git clone --branch 8.0.4 https://github.com/juce-framework/JUCE.git juce
          cd juce
          git checkout 8.0.4
          git config --global advice.detachedHead false

      - name: Configure CMake
        run: |
          cmake -G Ninja -DJUCE_SOURCE_DIR=${{ github.workspace }}/juce -S . -B cmake-build-ninja
          cat cmake-build-ninja/CMakeCache.txt | grep CMAKE_GENERATOR

      - name: Build Project
        run: cmake --build cmake-build-ninja

      - name: Run Tests
        run: ctest --test-dir cmake-build-ninja --output-on-failure